apiVersion: apps/v1
kind: Deployment
metadata:
  name: todoapp-backend
  namespace: todoapp
  labels:
    app: todoapp
    component: backend
    env: production
spec:
  replicas: 2
  selector:
    matchLabels:
      app: todoapp
      component: backend
  template:
    metadata:
      labels:
        app: todoapp
        component: backend
        env: production
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "3000"
        prometheus.io/path: "/metrics"
    spec:
      containers:
      - name: backend
        image: node:18-alpine
        workingDir: /app
        command:
        - sh
        - -c
        - |
          cat > server.js << 'EOJS'
          const express = require('express');
          const { Pool } = require('pg');
          const app = express();
          const PORT = 3000;

          const pool = new Pool({
            host: process.env.DB_HOST,
            port: 5432,
            database: 'tododb',
            user: process.env.DB_USER,
            password: process.env.DB_PASSWORD,
          });

          app.use(express.json());
          app.use((req, res, next) => {
            res.header('Access-Control-Allow-Origin', '*');
            res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
            res.header('Access-Control-Allow-Headers', 'Content-Type');
            if (req.method === 'OPTIONS') return res.sendStatus(200);
            next();
          });

          app.get('/health', (req, res) => res.json({ status: 'healthy' }));

          app.get('/api/todos', async (req, res) => {
            try {
              const result = await pool.query('SELECT * FROM todos ORDER BY created_at DESC');
              res.json(result.rows);
            } catch (err) {
              console.error(err);
              res.status(500).json({ error: 'Internal server error' });
            }
          });

          app.get('/api/todos/:id', async (req, res) => {
            try {
              const result = await pool.query('SELECT * FROM todos WHERE id = $1', [req.params.id]);
              if (result.rows.length === 0) return res.status(404).json({ error: 'Not found' });
              res.json(result.rows[0]);
            } catch (err) {
              res.status(500).json({ error: 'Internal server error' });
            }
          });

          app.post('/api/todos', async (req, res) => {
            const { title, description } = req.body;
            if (!title) return res.status(400).json({ error: 'Title required' });
            try {
              const result = await pool.query(
                'INSERT INTO todos (title, description) VALUES ($1, $2) RETURNING *',
                [title, description || '']
              );
              res.status(201).json(result.rows[0]);
            } catch (err) {
              res.status(500).json({ error: 'Internal server error' });
            }
          });

          app.put('/api/todos/:id', async (req, res) => {
            const { title, description, completed } = req.body;
            try {
              const result = await pool.query(
                'UPDATE todos SET title = COALESCE($1, title), description = COALESCE($2, description), completed = COALESCE($3, completed), updated_at = CURRENT_TIMESTAMP WHERE id = $4 RETURNING *',
                [title, description, completed, req.params.id]
              );
              if (result.rows.length === 0) return res.status(404).json({ error: 'Not found' });
              res.json(result.rows[0]);
            } catch (err) {
              res.status(500).json({ error: 'Internal server error' });
            }
          });

          app.delete('/api/todos/:id', async (req, res) => {
            try {
              const result = await pool.query('DELETE FROM todos WHERE id = $1 RETURNING *', [req.params.id]);
              if (result.rows.length === 0) return res.status(404).json({ error: 'Not found' });
              res.json({ message: 'Deleted successfully' });
            } catch (err) {
              res.status(500).json({ error: 'Internal server error' });
            }
          });

          app.listen(PORT, () => console.log(\`Server running on port \${PORT}\`));
          EOJS

          npm install express pg
          node server.js
        ports:
        - containerPort: 3000
          name: http
        env:
        - name: DB_HOST
          value: "todoapp-db-rw.todoapp.svc.cluster.local"
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: todoapp-db-credentials
              key: username
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: todoapp-db-credentials
              key: password
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 20
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: todoapp-backend
  namespace: todoapp
  labels:
    app: todoapp
    component: backend
spec:
  type: ClusterIP
  ports:
  - port: 3000
    targetPort: 3000
    protocol: TCP
    name: http
  selector:
    app: todoapp
    component: backend
