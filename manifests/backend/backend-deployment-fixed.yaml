apiVersion: v1
kind: ConfigMap
metadata:
  name: backend-code
  namespace: todoapp
data:
  server.js: |
    const express = require('express');
    const { Pool } = require('pg');
    const app = express();
    const PORT = 3000;

    const pool = new Pool({
      host: process.env.DB_HOST,
      port: 5432,
      database: 'tododb',
      user: process.env.DB_USER,
      password: process.env.DB_PASSWORD,
    });

    app.use(express.json());
    
    // CORS middleware
    app.use((req, res, next) => {
      res.header('Access-Control-Allow-Origin', '*');
      res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
      res.header('Access-Control-Allow-Headers', 'Content-Type');
      if (req.method === 'OPTIONS') {
        return res.sendStatus(200);
      }
      next();
    });

    // Health check
    app.get('/health', (req, res) => {
      res.json({ status: 'healthy', service: 'todoapp-backend' });
    });

    // Get all todos
    app.get('/api/todos', async (req, res) => {
      try {
        const result = await pool.query('SELECT * FROM todos ORDER BY created_at DESC');
        console.log('Fetched todos:', result.rows.length);
        res.json(result.rows);
      } catch (err) {
        console.error('Error fetching todos:', err);
        res.status(500).json({ error: 'Internal server error' });
      }
    });

    // Get single todo
    app.get('/api/todos/:id', async (req, res) => {
      try {
        const result = await pool.query('SELECT * FROM todos WHERE id = $1', [req.params.id]);
        if (result.rows.length === 0) {
          return res.status(404).json({ error: 'Todo not found' });
        }
        res.json(result.rows[0]);
      } catch (err) {
        console.error('Error fetching todo:', err);
        res.status(500).json({ error: 'Internal server error' });
      }
    });

    // Create todo
    app.post('/api/todos', async (req, res) => {
      const { title, description } = req.body;
      if (!title) {
        return res.status(400).json({ error: 'Title is required' });
      }
      
      try {
        const result = await pool.query(
          'INSERT INTO todos (title, description) VALUES ($1, $2) RETURNING *',
          [title, description || '']
        );
        console.log('Created todo:', result.rows[0].id);
        res.status(201).json(result.rows[0]);
      } catch (err) {
        console.error('Error creating todo:', err);
        res.status(500).json({ error: 'Internal server error' });
      }
    });

    // Update todo
    app.put('/api/todos/:id', async (req, res) => {
      const { title, description, completed } = req.body;
      
      try {
        const result = await pool.query(
          'UPDATE todos SET title = COALESCE($1, title), description = COALESCE($2, description), completed = COALESCE($3, completed), updated_at = CURRENT_TIMESTAMP WHERE id = $4 RETURNING *',
          [title, description, completed, req.params.id]
        );
        
        if (result.rows.length === 0) {
          return res.status(404).json({ error: 'Todo not found' });
        }
        
        console.log('Updated todo:', req.params.id);
        res.json(result.rows[0]);
      } catch (err) {
        console.error('Error updating todo:', err);
        res.status(500).json({ error: 'Internal server error' });
      }
    });

    // Delete todo
    app.delete('/api/todos/:id', async (req, res) => {
      try {
        const result = await pool.query('DELETE FROM todos WHERE id = $1 RETURNING *', [req.params.id]);
        
        if (result.rows.length === 0) {
          return res.status(404).json({ error: 'Todo not found' });
        }
        
        console.log('Deleted todo:', req.params.id);
        res.json({ message: 'Todo deleted successfully' });
      } catch (err) {
        console.error('Error deleting todo:', err);
        res.status(500).json({ error: 'Internal server error' });
      }
    });

    // Start server
    app.listen(PORT, '0.0.0.0', () => {
      console.log(`Todo Backend API running on port ${PORT}`);
      console.log(`Database: ${process.env.DB_HOST}`);
    });

  package.json: |
    {
      "name": "todoapp-backend",
      "version": "1.0.0",
      "main": "server.js",
      "dependencies": {
        "express": "^4.18.2",
        "pg": "^8.11.3"
      }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: todoapp-backend
  namespace: todoapp
  labels:
    app: todoapp
    component: backend
    env: production
spec:
  replicas: 2
  selector:
    matchLabels:
      app: todoapp
      component: backend
  template:
    metadata:
      labels:
        app: todoapp
        component: backend
        env: production
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "3000"
        prometheus.io/path: "/metrics"
    spec:
      initContainers:
      - name: install-deps
        image: node:18-alpine
        command:
        - sh
        - -c
        - |
          cd /app
          npm install
        volumeMounts:
        - name: app-code
          mountPath: /app
        - name: node-modules
          mountPath: /app/node_modules
      containers:
      - name: backend
        image: node:18-alpine
        command:
        - node
        - server.js
        workingDir: /app
        ports:
        - containerPort: 3000
          name: http
        env:
        - name: DB_HOST
          value: "todoapp-db-rw.todoapp.svc.cluster.local"
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: todoapp-db-credentials
              key: username
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: todoapp-db-credentials
              key: password
        - name: NODE_ENV
          value: "production"
        volumeMounts:
        - name: app-code
          mountPath: /app
        - name: node-modules
          mountPath: /app/node_modules
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 20
          periodSeconds: 5
      volumes:
      - name: app-code
        configMap:
          name: backend-code
      - name: node-modules
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: todoapp-backend
  namespace: todoapp
  labels:
    app: todoapp
    component: backend
spec:
  type: ClusterIP
  ports:
  - port: 3000
    targetPort: 3000
    protocol: TCP
    name: http
  selector:
    app: todoapp
    component: backend
